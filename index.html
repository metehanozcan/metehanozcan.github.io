<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Sinyal Botu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#F0B90B',
                        'primary-dark': '#D4AC0D',
                        'binance-green': '#02C076',
                        'binance-red': '#F6465D',
                        'binance-dark': '#1E2329',
                        'binance-darker': '#0B0E11',
                        'binance-gray': '#2B3139',
                        'binance-light-gray': '#474D57'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-binance-darker text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Dark Mode Setup -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="min-h-screen bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-binance-darker dark:to-binance-dark">
        <!-- Header -->
        <header class="bg-white dark:bg-binance-dark shadow-lg border-b border-gray-200 dark:border-binance-gray">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-lg"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Binance Sinyal Botu</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="connectionStatus" class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Bağlantı Bekleniyor</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Control Panel -->
            <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-8 border border-gray-200 dark:border-binance-gray">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-cog mr-2 text-primary"></i>
                    Kontrol Paneli
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Finansal Varlık</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="symbolInput" 
                                placeholder="Örnek: BTCUSDT" 
                                class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                value="BTCUSDT"
                            >
                            <i class="fas fa-coins absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Tarama Aralığı</label>
                        <select id="intervalSelect" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="30">30 Saniye</option>
                            <option value="60" selected>1 Dakika</option>
                            <option value="120">2 Dakika</option>
                            <option value="300">5 Dakika</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button 
                            id="toggleBot" 
                            class="w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-medium flex items-center justify-center space-x-2"
                        >
                            <i id="botIcon" class="fas fa-play"></i>
                            <span id="botText">Botu Başlat</span>
                        </button>
                    </div>
                </div>

                <!-- Settings Row -->
                <div class="flex flex-wrap items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-600">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="soundEnabled" checked class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-sm">Ses Uyarısı</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="pushEnabled" checked class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                            <span class="text-sm">Push Bildirim</span>
                        </label>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Son Güncelleme: <span id="lastUpdate">-</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Market Data -->
                <div class="lg:col-span-2">
                    <!-- Current Price Card -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-binance-gray">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-chart-area mr-2 text-primary"></i>
                                Güncel Piyasa Verileri
                            </h3>
                            <div id="priceChangeIndicator" class="flex items-center space-x-2">
                                <span id="priceChange" class="text-sm font-medium">-</span>
                                <i id="priceArrow" class="fas fa-minus text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-primary" id="currentPrice">-</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Güncel Fiyat</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold" id="volume24h">-</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">24s Hacim</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold" id="high24h">-</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">24s Yüksek</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-semibold" id="low24h">-</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">24s Düşük</div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Indicators -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-primary"></i>
                            Teknik Göstergeler
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">RSI (21)</span>
                                    <span id="rsi21" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">RSI (34)</span>
                                    <span id="rsi34" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">EMA (8)</span>
                                    <span id="ema8" class="font-medium">-</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">WMA (34)</span>
                                    <span id="wma34" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">VWMA (21)</span>
                                    <span id="vwma21" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Pivot</span>
                                    <span id="pivot" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pivot Levels -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-layer-group mr-2 text-primary"></i>
                            Camarilla Pivot Seviyeleri
                        </h3>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between items-center py-2 px-3 bg-red-50 dark:bg-binance-red/10 rounded-lg border dark:border-binance-red/30">
                                <span class="text-sm font-medium text-binance-red">R4 (Arz)</span>
                                <span id="r4Level" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 px-3 bg-red-50 dark:bg-binance-red/10 rounded-lg border dark:border-binance-red/30">
                                <span class="text-sm font-medium text-binance-red">R3 (Arz)</span>
                                <span id="r3Level" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 px-3 bg-yellow-50 dark:bg-primary/10 rounded-lg border dark:border-primary/30">
                                <span class="text-sm font-medium text-primary">Pivot</span>
                                <span id="pivotLevel" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 px-3 bg-green-50 dark:bg-binance-green/10 rounded-lg border dark:border-binance-green/30">
                                <span class="text-sm font-medium text-binance-green">S3 (Talep)</span>
                                <span id="s3Level" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between items-center py-2 px-3 bg-green-50 dark:bg-binance-green/10 rounded-lg border dark:border-binance-green/30">
                                <span class="text-sm font-medium text-binance-green">S4 (Talep)</span>
                                <span id="s4Level" class="font-medium">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- TradingView Chart -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <i class="fas fa-chart-candlestick mr-2 text-primary"></i>
                                Canlı Grafik
                            </span>
                            <div class="flex items-center space-x-2">
                                <select id="chartTimeframe" class="text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="5">5m</option>
                                    <option value="15" selected>15m</option>
                                    <option value="60">1h</option>
                                    <option value="240">4h</option>
                                    <option value="D">1D</option>
                                </select>
                                <button id="refreshChart" class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-opacity-90">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </h3>
                        
                        <div class="rounded-lg overflow-hidden" style="height: 500px;">
                            <!-- TradingView Widget BEGIN -->
                            <div id="tradingview_chart" class="tradingview-widget-container" style="height:100%;width:100%">
                                <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                                <div class="tradingview-widget-copyright">
                                    <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                                        <span class="text-xs text-gray-500">Powered by TradingView</span>
                                    </a>
                                </div>
                            </div>
                            <!-- TradingView Widget END -->
                        </div>
                    </div>
                </div>

                <!-- Signals Panel -->
                <div class="space-y-6">
                    <!-- Active Signals -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-bell mr-2 text-primary"></i>
                            Aktif Sinyaller
                        </h3>
                        
                        <div id="activeSignals" class="space-y-3">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <i class="fas fa-search text-2xl mb-2 text-primary"></i>
                                <p>Sinyal bekleniyor...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Signal History -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center justify-between">
                            <span class="flex items-center">
                                <i class="fas fa-history mr-2 text-primary"></i>
                                Sinyal Geçmişi
                            </span>
                            <button id="clearHistory" class="text-xs text-gray-500 hover:text-binance-red transition-colors">
                                <i class="fas fa-trash mr-1"></i>Temizle
                            </button>
                        </h3>
                        
                        <div id="signalHistory" class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                <p class="text-sm">Henüz sinyal geçmişi yok</p>
                            </div>
                        </div>
                    </div>

                    <!-- Confluence Analysis -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-crosshairs mr-2 text-primary"></i>
                            Confluence Analizi
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Signal Strength -->
                            <div class="text-center">
                                <div class="mb-2">
                                    <span class="text-2xl font-bold" id="signalStrengthScore">0</span>
                                    <span class="text-sm text-gray-500">/5</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                                    <div id="signalStrengthBar" class="h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <div id="signalQuality" class="text-sm font-medium">Sinyal Yok</div>
                            </div>
                            
                            <!-- Zone Analysis -->
                            <div class="grid grid-cols-2 gap-3">
                                <div id="supplyZoneCard" class="p-3 rounded-lg border text-center opacity-50">
                                    <div class="text-binance-red mb-1">
                                        <i class="fas fa-arrow-down"></i>
                                    </div>
                                    <div class="text-xs font-medium">Arz Bölgesi</div>
                                    <div class="text-xs text-gray-500">Satım Sinyali</div>
                                </div>
                                <div id="demandZoneCard" class="p-3 rounded-lg border text-center opacity-50">
                                    <div class="text-binance-green mb-1">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <div class="text-xs font-medium">Talep Bölgesi</div>
                                    <div class="text-xs text-gray-500">Alım Sinyali</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Panel -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-trophy mr-2 text-primary"></i>
                            Performans
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Win Rate Circle -->
                            <div class="text-center">
                                <div class="relative inline-flex items-center justify-center w-20 h-20">
                                    <svg class="w-20 h-20 transform -rotate-90">
                                        <circle cx="40" cy="40" r="30" stroke="currentColor" stroke-width="6" fill="transparent" class="text-gray-200 dark:text-gray-700"/>
                                        <circle id="winRateCircle" cx="40" cy="40" r="30" stroke="currentColor" stroke-width="6" fill="transparent" stroke-linecap="round" class="text-binance-green transition-all duration-500" stroke-dasharray="188.4" stroke-dashoffset="188.4"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="winRatePercentage" class="text-lg font-bold">0%</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Başarı Oranı</div>
                            </div>
                            
                            <!-- Performance Stats -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600 dark:text-gray-400">Toplam P&L</span>
                                    <span id="totalPL" class="font-medium text-gray-500">0.00%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600 dark:text-gray-400">Başarılı</span>
                                    <span id="successfulSignals" class="font-medium text-binance-green">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600 dark:text-gray-400">Başarısız</span>
                                    <span id="failedSignals" class="font-medium text-binance-red">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-600 dark:text-gray-400">Beklemede</span>
                                    <span id="pendingSignals" class="font-medium text-primary">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="bg-white dark:bg-binance-dark rounded-xl shadow-lg p-6 border border-gray-200 dark:border-binance-gray">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-primary"></i>
                            İstatistikler
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Toplam Sinyal</span>
                                <span id="totalSignals" class="font-medium text-primary">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Alım Sinyali</span>
                                <span id="buySignals" class="font-medium text-binance-green">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Satım Sinyali</span>
                                <span id="sellSignals" class="font-medium text-binance-red">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Çalışma Süresi</span>
                                <span id="uptime" class="font-medium">00:00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Modal -->
    <div id="signalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center mb-6">
                <div id="signalIcon" class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-2xl text-white"></i>
                </div>
                <h3 id="signalTitle" class="text-xl font-bold mb-2">Yeni Sinyal!</h3>
                <p id="signalMessage" class="text-gray-600 dark:text-gray-400"></p>
            </div>
            
            <div id="signalDetails" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4 space-y-2">
                <!-- Signal details will be inserted here -->
            </div>
            
            <div class="flex space-x-3">
                <button id="closeSignalModal" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                    Kapat
                </button>
                <button id="ackSignalModal" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                    Tamam
                </button>
            </div>
        </div>
    </div>

    <script>
        class BinanceSignalBot {
            constructor() {
                this.isRunning = false;
                this.symbol = 'BTCUSDT';
                this.interval = 60000; // 1 minute
                this.htfInterval = '4h';
                this.ltfInterval = '15m';
                this.candleLimit = 100;
                this.apiBase = 'https://api.binance.com/api/v3';
                this.intervalId = null;
                this.startTime = null;
                this.uptimeInterval = null;
                
                // Statistics
                this.stats = {
                    total: 0,
                    buy: 0,
                    sell: 0,
                    successful: 0,
                    failed: 0,
                    pending: 0,
                    totalProfitLoss: 0,
                    winRate: 0
                };
                
                // Active signals tracking
                this.activeSignalsTracking = new Map();
                
                this.initializeEventListeners();
                this.requestNotificationPermission();
            }

            // Technical Indicator Calculations
            calculateEMA(prices, period) {
                const ema = [];
                let multiplier = 2 / (period + 1);
                ema[0] = prices[0];
                for (let i = 1; i < prices.length; i++) {
                    ema[i] = (prices[i] * multiplier) + (ema[i - 1] * (1 - multiplier));
                }
                return ema;
            }

            calculateWMA(prices, period) {
                const wma = [];
                for (let i = period - 1; i < prices.length; i++) {
                    let sum = 0, weightSum = 0;
                    for (let j = 0; j < period; j++) {
                        const weight = period - j;
                        sum += prices[i - j] * weight;
                        weightSum += weight;
                    }
                    wma.push(sum / weightSum);
                }
                return wma;
            }

            calculateVWMA(prices, volumes, period) {
                const vwma = [];
                for (let i = period - 1; i < prices.length; i++) {
                    let pvSum = 0, vSum = 0;
                    for (let j = 0; j < period; j++) {
                        pvSum += prices[i - j] * volumes[i - j];
                        vSum += volumes[i - j];
                    }
                    vwma.push(pvSum / vSum);
                }
                return vwma;
            }

            calculateRSI(prices, period) {
                const rsi = [];
                let gains = 0, losses = 0;
                
                for (let i = 1; i < period; i++) {
                    const diff = prices[i] - prices[i - 1];
                    if (diff > 0) gains += diff;
                    else losses -= diff;
                }
                
                let avgGain = gains / period;
                let avgLoss = losses / period;
                rsi.push(100 - (100 / (1 + (avgGain / avgLoss))));

                for (let i = period; i < prices.length; i++) {
                    const diff = prices[i] - prices[i - 1];
                    const currentGain = diff > 0 ? diff : 0;
                    const currentLoss = diff < 0 ? -diff : 0;
                    avgGain = (avgGain * (period - 1) + currentGain) / period;
                    avgLoss = (avgLoss * (period - 1) + currentLoss) / period;
                    rsi.push(100 - (100 / (1 + (avgGain / avgLoss))));
                }
                return rsi;
            }

            checkRSIDivergence(rsiValues, prices) {
                const lastRsi = rsiValues[rsiValues.length - 1];
                const prevRsi = rsiValues[rsiValues.length - 2];
                const lastPrice = prices[prices.length - 1];
                const prevPrice = prices[prices.length - 2];
                
                if (lastPrice > prevPrice && lastRsi < prevRsi) return 'Bearish Divergence (Satım Sinyali)';
                if (lastPrice < prevPrice && lastRsi > prevRsi) return 'Bullish Divergence (Alım Sinyali)';
                return null;
            }

            calculateCamarillaPivots(high, low, close) {
                const range = high - low;
                const pivot = (high + low + close) / 3;
                const r4 = close + range * 1.1 / 2;
                const r3 = close + range * 1.1 / 4;
                const s3 = close - range * 1.1 / 4;
                const s4 = close - range * 1.1 / 2;
                return { pivot, r3, r4, s3, s4 };
            }

            // API Functions
            async fetchCandles(interval) {
                try {
                    const response = await fetch(`${this.apiBase}/klines?symbol=${this.symbol}&interval=${interval}&limit=${this.candleLimit}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    return data.map(c => ({
                        open: parseFloat(c[1]),
                        high: parseFloat(c[2]),
                        low: parseFloat(c[3]),
                        close: parseFloat(c[4]),
                        volume: parseFloat(c[5])
                    }));
                } catch (error) {
                    console.error('Error fetching candles:', error);
                    this.updateConnectionStatus(false);
                    throw error;
                }
            }

            async fetch24hrStats() {
                try {
                    const response = await fetch(`${this.apiBase}/ticker/24hr?symbol=${this.symbol}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching 24hr stats:', error);
                    throw error;
                }
            }

            // HTF Signal Analysis - Arz/Talep Bölgesi Belirleme
            async checkHTFSignals() {
                const candles = await this.fetchCandles(this.htfInterval);
                const closes = candles.map(c => c.close);
                const highs = candles.map(c => c.high);
                const lows = candles.map(c => c.low);
                const volumes = candles.map(c => c.volume);
                const currentPrice = closes[closes.length - 1];

                let signals = [];
                let signalStrength = 0;
                let supplyZone = false;
                let demandZone = false;

                // 1. PRICE X VWMA21 - Arz/Talep Bölgesi Belirleme
                const vwma21 = this.calculateVWMA(closes, volumes, 21);
                const lastVwma = vwma21[vwma21.length - 1];
                if (currentPrice > lastVwma) {
                    signals.push('✅ VWMA21 Üstü (Potansiyel Arz Bölgesi)');
                    supplyZone = true;
                    signalStrength++;
                }
                if (currentPrice < lastVwma) {
                    signals.push('✅ VWMA21 Altı (Potansiyel Talep Bölgesi)');
                    demandZone = true;
                    signalStrength++;
                }

                // 2. RSI 21-34 Aşırı Alım/Satım Bandları
                const rsi21 = this.calculateRSI(closes, 21);
                const rsi34 = this.calculateRSI(closes, 34);
                const lastRsi21 = rsi21[rsi21.length - 1];
                const lastRsi34 = rsi34[rsi34.length - 1];
                
                if (lastRsi21 > 70 || lastRsi34 > 70) {
                    signals.push('✅ RSI Aşırı Alım (>70) - Satım Bölgesi');
                    supplyZone = true;
                    signalStrength++;
                }
                if (lastRsi21 < 30 || lastRsi34 < 30) {
                    signals.push('✅ RSI Aşırı Satım (<30) - Alım Bölgesi');
                    demandZone = true;
                    signalStrength++;
                }

                // 3. EMA8 X WMA34 Kesişim Analizi
                const ema8 = this.calculateEMA(closes, 8);
                const wma34 = this.calculateWMA(closes, 34);
                const lastEma8 = ema8[ema8.length - 1];
                const lastWma34 = wma34[wma34.length - 1];
                const prevEma8 = ema8[ema8.length - 2];
                const prevWma34 = wma34[wma34.length - 2];
                
                // Bullish Crossover (Alım Sinyali)
                if (lastEma8 > lastWma34 && prevEma8 <= prevWma34) {
                    signals.push('✅ EMA8 > WMA34 (Yükseliş Kesişimi) - Alım Sinyali');
                    demandZone = true;
                    signalStrength++;
                }
                // Bearish Crossover (Satım Sinyali)
                if (lastEma8 < lastWma34 && prevEma8 >= prevWma34) {
                    signals.push('✅ EMA8 < WMA34 (Düşüş Kesişimi) - Satım Sinyali');
                    supplyZone = true;
                    signalStrength++;
                }

                // 4. RSI Divergence - Tepe/Dip Uyumsuzluk
                const divergence = this.checkRSIDivergence(rsi21, closes) || this.checkRSIDivergence(rsi34, closes);
                if (divergence) {
                    signals.push(`✅ RSI Uyumsuzluk: ${divergence}`);
                    if (divergence.includes('Bearish')) {
                        supplyZone = true;
                        signalStrength++;
                    }
                    if (divergence.includes('Bullish')) {
                        demandZone = true;
                        signalStrength++;
                    }
                }

                // 5. Camarilla Pivot Seviyeleri
                const lastHigh = highs[highs.length - 1];
                const lastLow = lows[lows.length - 1];
                const lastClose = closes[closes.length - 1];
                const pivots = this.calculateCamarillaPivots(lastHigh, lastLow, lastClose);
                
                if (currentPrice > pivots.r4) {
                    signals.push('✅ Camarilla R4 Üstü (Güçlü Arz Bölgesi)');
                    supplyZone = true;
                    signalStrength += 2; // R4 daha güçlü sinyal
                }
                else if (currentPrice > pivots.r3) {
                    signals.push('✅ Camarilla R3 Üstü (Arz Bölgesi)');
                    supplyZone = true;
                    signalStrength++;
                }
                
                if (currentPrice < pivots.s4) {
                    signals.push('✅ Camarilla S4 Altı (Güçlü Talep Bölgesi)');
                    demandZone = true;
                    signalStrength += 2; // S4 daha güçlü sinyal
                }
                else if (currentPrice < pivots.s3) {
                    signals.push('✅ Camarilla S3 Altı (Talep Bölgesi)');
                    demandZone = true;
                    signalStrength++;
                }

                // Sinyal Gücü Değerlendirmesi
                let signalQuality = 'Zayıf';
                if (signalStrength >= 2) signalQuality = 'Orta';
                if (signalStrength >= 3) signalQuality = 'Güçlü';
                if (signalStrength >= 4) signalQuality = 'Çok Güçlü';

                // Update UI with indicators and signal strength
                this.updateTechnicalIndicators({
                    rsi21: lastRsi21,
                    rsi34: lastRsi34,
                    ema8: lastEma8,
                    wma34: lastWma34,
                    vwma21: lastVwma,
                    pivots: pivots
                });

                // Update confluence analysis in UI
                this.updateConfluenceAnalysis({
                    signalStrength,
                    signalQuality,
                    supplyZone,
                    demandZone,
                    currentPrice,
                    vwma21: lastVwma
                });

                return { 
                    signals, 
                    currentPrice, 
                    pivots, 
                    signalStrength, 
                    signalQuality,
                    supplyZone,
                    demandZone
                };
            }

            async generateLTFSignal(htfSignals, htfPrice, pivots) {
                const candles = await this.fetchCandles(this.ltfInterval);
                const closes = candles.map(c => c.close);
                const currentPrice = closes[closes.length - 1];

                let action = '';
                let entry = currentPrice;
                let stopLoss, takeProfit;

                if (htfSignals.some(s => s.includes('Arz') || s.includes('Aşırı Alım') || s.includes('Düşüş') || s.includes('Bearish'))) {
                    action = 'SATIM';
                    stopLoss = htfPrice * 1.02;
                    takeProfit = htfPrice * 0.95;
                } else if (htfSignals.some(s => s.includes('Talep') || s.includes('Aşırı Satım') || s.includes('Yükseliş') || s.includes('Bullish'))) {
                    action = 'ALIM';
                    stopLoss = htfPrice * 0.98;
                    takeProfit = htfPrice * 1.05;
                }

                if (action) {
                    const signalId = `${this.symbol}_${Date.now()}`;
                    const signal = {
                        id: signalId,
                        type: action,
                        symbol: this.symbol,
                        entry: entry,
                        stopLoss: stopLoss,
                        takeProfit: takeProfit,
                        reasons: htfSignals,
                        timestamp: new Date(),
                        status: 'pending' // pending, success, failed
                    };

                    // Start tracking this signal
                    this.activeSignalsTracking.set(signalId, signal);
                    this.stats.pending++;

                    this.showSignal(signal);
                    this.addToHistory(signal);
                    this.updateStats(action);
                    this.updatePerformanceUI();
                }
            }

            // Signal tracking and performance calculation
            async checkSignalPerformance() {
                if (this.activeSignalsTracking.size === 0) return;

                try {
                    const currentCandles = await this.fetchCandles('1m');
                    const currentPrice = currentCandles[currentCandles.length - 1].close;
                    const high24h = Math.max(...currentCandles.slice(-1440).map(c => c.high));
                    const low24h = Math.min(...currentCandles.slice(-1440).map(c => c.low));

                    for (const [signalId, signal] of this.activeSignalsTracking) {
                        if (signal.status !== 'pending') continue;

                        let signalResult = null;
                        let profitLoss = 0;

                        if (signal.type === 'ALIM') {
                            // Check if TP hit
                            if (high24h >= signal.takeProfit) {
                                signalResult = 'success';
                                profitLoss = ((signal.takeProfit - signal.entry) / signal.entry) * 100;
                            }
                            // Check if SL hit
                            else if (low24h <= signal.stopLoss) {
                                signalResult = 'failed';
                                profitLoss = ((signal.stopLoss - signal.entry) / signal.entry) * 100;
                            }
                        } else if (signal.type === 'SATIM') {
                            // Check if TP hit (price goes down)
                            if (low24h <= signal.takeProfit) {
                                signalResult = 'success';
                                profitLoss = ((signal.entry - signal.takeProfit) / signal.entry) * 100;
                            }
                            // Check if SL hit (price goes up)
                            else if (high24h >= signal.stopLoss) {
                                signalResult = 'failed';
                                profitLoss = ((signal.entry - signal.stopLoss) / signal.entry) * 100;
                            }
                        }

                        // Update signal status if result determined
                        if (signalResult) {
                            signal.status = signalResult;
                            signal.profitLoss = profitLoss;
                            signal.closedAt = new Date();

                            // Update stats
                            this.stats.pending--;
                            if (signalResult === 'success') {
                                this.stats.successful++;
                            } else {
                                this.stats.failed++;
                            }
                            this.stats.totalProfitLoss += profitLoss;

                            // Calculate win rate
                            const totalCompleted = this.stats.successful + this.stats.failed;
                            this.stats.winRate = totalCompleted > 0 ? (this.stats.successful / totalCompleted) * 100 : 0;

                            // Update signal in history
                            this.updateSignalInHistory(signal);

                            console.log(`Signal ${signalId} completed: ${signalResult} with ${profitLoss.toFixed(2)}% P&L`);
                        }

                        // Remove signals older than 24 hours if still pending
                        const hoursSinceSignal = (Date.now() - signal.timestamp.getTime()) / (1000 * 60 * 60);
                        if (hoursSinceSignal > 24 && signal.status === 'pending') {
                            this.activeSignalsTracking.delete(signalId);
                            this.stats.pending--;
                            console.log(`Signal ${signalId} expired after 24 hours`);
                        }
                    }

                    this.updatePerformanceUI();
                } catch (error) {
                    console.error('Error checking signal performance:', error);
                }
            }

            updateSignalInHistory(signal) {
                const container = document.getElementById('signalHistory');
                const elements = container.querySelectorAll('.signal-history-item');
                
                elements.forEach(element => {
                    if (element.dataset.signalId === signal.id) {
                        const statusIcon = signal.status === 'success' ? '✅' : '❌';
                        const statusClass = signal.status === 'success' ? 'text-binance-green' : 'text-binance-red';
                        const plText = signal.profitLoss > 0 ? `+${signal.profitLoss.toFixed(2)}%` : `${signal.profitLoss.toFixed(2)}%`;
                        
                        element.innerHTML = `
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm ${signal.type === 'ALIM' ? 'text-binance-green' : 'text-binance-red'}">${signal.type} - ${signal.symbol} ${statusIcon}</span>
                                <span class="text-xs text-gray-500">${signal.timestamp.toLocaleString()}</span>
                            </div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">
                                Giriş: ${signal.entry.toFixed(4)} | SL: ${signal.stopLoss.toFixed(4)} | TP: ${signal.takeProfit.toFixed(4)}
                            </div>
                            <div class="text-xs ${statusClass} mt-1">
                                P&L: ${plText} | Durum: ${signal.status === 'success' ? 'Başarılı' : 'Başarısız'}
                            </div>
                        `;
                    }
                });
            }

            updatePerformanceUI() {
                // Update performance stats
                document.getElementById('successfulSignals').textContent = this.stats.successful;
                document.getElementById('failedSignals').textContent = this.stats.failed;
                document.getElementById('pendingSignals').textContent = this.stats.pending;
                
                // Update total P&L
                const totalPLElement = document.getElementById('totalPL');
                const plColor = this.stats.totalProfitLoss >= 0 ? 'text-binance-green' : 'text-binance-red';
                const plSign = this.stats.totalProfitLoss >= 0 ? '+' : '';
                totalPLElement.textContent = `${plSign}${this.stats.totalProfitLoss.toFixed(2)}%`;
                totalPLElement.className = `font-medium ${plColor}`;
                
                // Update win rate circle
                const winRatePercentage = document.getElementById('winRatePercentage');
                const winRateCircle = document.getElementById('winRateCircle');
                
                winRatePercentage.textContent = `${Math.round(this.stats.winRate)}%`;
                
                // Calculate circle progress
                const circumference = 2 * Math.PI * 30; // radius = 30
                const offset = circumference - (this.stats.winRate / 100) * circumference;
                winRateCircle.style.strokeDashoffset = offset;
                
                // Color based on win rate
                if (this.stats.winRate >= 70) {
                    winRateCircle.className = 'text-binance-green transition-all duration-500';
                } else if (this.stats.winRate >= 50) {
                    winRateCircle.className = 'text-primary transition-all duration-500';
                } else {
                    winRateCircle.className = 'text-binance-red transition-all duration-500';
                }
            }

            // UI Updates
            updateTechnicalIndicators(indicators) {
                document.getElementById('rsi21').textContent = indicators.rsi21.toFixed(2);
                document.getElementById('rsi34').textContent = indicators.rsi34.toFixed(2);
                document.getElementById('ema8').textContent = indicators.ema8.toFixed(4);
                document.getElementById('wma34').textContent = indicators.wma34.toFixed(4);
                document.getElementById('vwma21').textContent = indicators.vwma21.toFixed(4);
                document.getElementById('pivot').textContent = indicators.pivots.pivot.toFixed(4);

                // Update pivot levels
                document.getElementById('r4Level').textContent = indicators.pivots.r4.toFixed(4);
                document.getElementById('r3Level').textContent = indicators.pivots.r3.toFixed(4);
                document.getElementById('pivotLevel').textContent = indicators.pivots.pivot.toFixed(4);
                document.getElementById('s3Level').textContent = indicators.pivots.s3.toFixed(4);
                document.getElementById('s4Level').textContent = indicators.pivots.s4.toFixed(4);
            }

            async updateMarketData() {
                try {
                    const stats = await this.fetch24hrStats();
                    const currentPrice = parseFloat(stats.lastPrice);
                    const priceChange = parseFloat(stats.priceChangePercent);

                    document.getElementById('currentPrice').textContent = currentPrice.toFixed(4);
                    document.getElementById('volume24h').textContent = this.formatVolume(parseFloat(stats.volume));
                    document.getElementById('high24h').textContent = parseFloat(stats.highPrice).toFixed(4);
                    document.getElementById('low24h').textContent = parseFloat(stats.lowPrice).toFixed(4);

                    // Price change indicator
                    const changeElement = document.getElementById('priceChange');
                    const arrowElement = document.getElementById('priceArrow');
                    
                    changeElement.textContent = `${priceChange > 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
                    
                    if (priceChange > 0) {
                        changeElement.className = 'text-sm font-medium text-binance-green';
                        arrowElement.className = 'fas fa-arrow-up text-binance-green';
                    } else if (priceChange < 0) {
                        changeElement.className = 'text-sm font-medium text-binance-red';
                        arrowElement.className = 'fas fa-arrow-down text-binance-red';
                    } else {
                        changeElement.className = 'text-sm font-medium text-gray-500';
                        arrowElement.className = 'fas fa-minus text-gray-500';
                    }

                    this.updateConnectionStatus(true);
                } catch (error) {
                    console.error('Error updating market data:', error);
                    this.updateConnectionStatus(false);
                }
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                if (connected) {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Bağlı</span>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Bağlantı Hatası</span>
                    `;
                }
            }

            formatVolume(volume) {
                if (volume >= 1e9) return (volume / 1e9).toFixed(2) + 'B';
                if (volume >= 1e6) return (volume / 1e6).toFixed(2) + 'M';
                if (volume >= 1e3) return (volume / 1e3).toFixed(2) + 'K';
                return volume.toFixed(2);
            }

            showSignal(signal) {
                // Show modal
                const modal = document.getElementById('signalModal');
                const icon = document.getElementById('signalIcon');
                const title = document.getElementById('signalTitle');
                const message = document.getElementById('signalMessage');
                const details = document.getElementById('signalDetails');

                // Set signal type styling with Binance colors
                if (signal.type === 'ALIM') {
                    icon.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-binance-green';
                    icon.innerHTML = '<i class="fas fa-arrow-up text-2xl text-white"></i>';
                    title.textContent = 'ALIM SİNYALİ!';
                    title.className = 'text-xl font-bold mb-2 text-binance-green';
                } else {
                    icon.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-binance-red';
                    icon.innerHTML = '<i class="fas fa-arrow-down text-2xl text-white"></i>';
                    title.textContent = 'SATIM SİNYALİ!';
                    title.className = 'text-xl font-bold mb-2 text-binance-red';
                }

                message.textContent = `${signal.symbol} için ${signal.type.toLowerCase()} sinyali algılandı.`;

                details.innerHTML = `
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between"><span>Giriş:</span><span class="font-medium">${signal.entry.toFixed(4)}</span></div>
                        <div class="flex justify-between"><span>Stop Loss:</span><span class="font-medium">${signal.stopLoss.toFixed(4)}</span></div>
                        <div class="flex justify-between"><span>Take Profit:</span><span class="font-medium">${signal.takeProfit.toFixed(4)}</span></div>
                        <div class="pt-2 border-t border-gray-200 dark:border-gray-600">
                            <div class="text-xs text-gray-600 dark:text-gray-400">Sebepler:</div>
                            ${signal.reasons.map(reason => `<div class="text-xs">• ${reason}</div>`).join('')}
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');

                // Sound notification
                if (document.getElementById('soundEnabled').checked) {
                    this.playNotificationSound(signal.type);
                }

                // Push notification
                if (document.getElementById('pushEnabled').checked && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${signal.type} Sinyali - ${signal.symbol}`, {
                        body: `Giriş: ${signal.entry.toFixed(4)}`,
                        icon: signal.type === 'ALIM' ? '📈' : '📉'
                    });
                }

                // Update active signals
                this.updateActiveSignals(signal);
            }

            updateActiveSignals(signal) {
                const container = document.getElementById('activeSignals');
                
                // Remove empty state
                if (container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }

                const signalElement = document.createElement('div');
                signalElement.className = `p-4 rounded-lg border-l-4 ${
                    signal.type === 'ALIM' 
                        ? 'bg-green-50 dark:bg-binance-green/10 border-binance-green' 
                        : 'bg-red-50 dark:bg-binance-red/10 border-binance-red'
                }`;
                
                signalElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium ${signal.type === 'ALIM' ? 'text-binance-green' : 'text-binance-red'}">${signal.type}</span>
                        <span class="text-xs text-gray-500">${signal.timestamp.toLocaleTimeString()}</span>
                    </div>
                    <div class="text-sm space-y-1">
                        <div>Giriş: <span class="font-medium">${signal.entry.toFixed(4)}</span></div>
                        <div>SL: <span class="font-medium">${signal.stopLoss.toFixed(4)}</span></div>
                        <div>TP: <span class="font-medium">${signal.takeProfit.toFixed(4)}</span></div>
                    </div>
                `;
                
                container.appendChild(signalElement);

                // Remove signal after 5 minutes
                setTimeout(() => {
                    if (signalElement.parentNode) {
                        signalElement.remove();
                        if (container.children.length === 0) {
                            container.innerHTML = `
                                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                    <i class="fas fa-search text-2xl mb-2"></i>
                                    <p>Sinyal bekleniyor...</p>
                                </div>
                            `;
                        }
                    }
                }, 300000);
            }

            addToHistory(signal) {
                const container = document.getElementById('signalHistory');
                
                // Remove empty state
                if (container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }

                const historyElement = document.createElement('div');
                historyElement.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                
                historyElement.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-medium text-sm ${signal.type === 'ALIM' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${signal.type} - ${signal.symbol}</span>
                        <span class="text-xs text-gray-500">${signal.timestamp.toLocaleString()}</span>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        Giriş: ${signal.entry.toFixed(4)} | SL: ${signal.stopLoss.toFixed(4)} | TP: ${signal.takeProfit.toFixed(4)}
                    </div>
                `;
                
                container.insertBefore(historyElement, container.firstChild);

                // Keep only last 50 signals
                while (container.children.length > 50) {
                    container.removeChild(container.lastChild);
                }
            }

            updateConfluenceAnalysis(data) {
                const { signalStrength, signalQuality, supplyZone, demandZone } = data;
                
                // Update signal strength
                document.getElementById('signalStrengthScore').textContent = signalStrength;
                document.getElementById('signalQuality').textContent = signalQuality;
                
                // Update progress bar
                const percentage = Math.min((signalStrength / 5) * 100, 100);
                const progressBar = document.getElementById('signalStrengthBar');
                progressBar.style.width = `${percentage}%`;
                
                // Color based on strength
                if (signalStrength === 0) {
                    progressBar.className = 'h-3 rounded-full transition-all duration-500 bg-gray-400';
                    document.getElementById('signalQuality').className = 'text-sm font-medium text-gray-500';
                } else if (signalStrength < 2) {
                    progressBar.className = 'h-3 rounded-full transition-all duration-500 bg-red-400';
                    document.getElementById('signalQuality').className = 'text-sm font-medium text-red-500';
                } else if (signalStrength < 3) {
                    progressBar.className = 'h-3 rounded-full transition-all duration-500 bg-yellow-400';
                    document.getElementById('signalQuality').className = 'text-sm font-medium text-yellow-600';
                } else if (signalStrength < 4) {
                    progressBar.className = 'h-3 rounded-full transition-all duration-500 bg-primary';
                    document.getElementById('signalQuality').className = 'text-sm font-medium text-primary';
                } else {
                    progressBar.className = 'h-3 rounded-full transition-all duration-500 bg-binance-green';
                    document.getElementById('signalQuality').className = 'text-sm font-medium text-binance-green';
                }
                
                // Update zone cards
                const supplyCard = document.getElementById('supplyZoneCard');
                const demandCard = document.getElementById('demandZoneCard');
                
                if (supplyZone) {
                    supplyCard.className = 'p-3 rounded-lg border text-center bg-red-50 dark:bg-binance-red/10 border-binance-red transform scale-105 transition-all';
                    supplyCard.style.opacity = '1';
                } else {
                    supplyCard.className = 'p-3 rounded-lg border text-center opacity-50 transition-all';
                }
                
                if (demandZone) {
                    demandCard.className = 'p-3 rounded-lg border text-center bg-green-50 dark:bg-binance-green/10 border-binance-green transform scale-105 transition-all';
                    demandCard.style.opacity = '1';
                } else {
                    demandCard.className = 'p-3 rounded-lg border text-center opacity-50 transition-all';
                }
            }

            updateStats(signalType) {
                this.stats.total++;
                if (signalType === 'ALIM') this.stats.buy++;
                else this.stats.sell++;

                document.getElementById('totalSignals').textContent = this.stats.total;
                document.getElementById('buySignals').textContent = this.stats.buy;
                document.getElementById('sellSignals').textContent = this.stats.sell;
            }

            playNotificationSound(signalType) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const frequency = signalType === 'ALIM' ? 800 : 400;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }

            updateUptime() {
                if (!this.startTime) return;
                
                const elapsed = Date.now() - this.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Main Bot Loop
            async runScanCycle() {
                try {
                    await this.updateMarketData();
                    
                    // Check performance of existing signals
                    await this.checkSignalPerformance();
                    
                    const htfData = await this.checkHTFSignals();
                    if (htfData.signals.length > 0) {
                        console.log(`HTF Sinyalleri: ${htfData.signals.join(', ')}`);
                        if (htfData.signals.length > 1) {
                            console.log('Güçlü Sinyal! Birden fazla eşleşme.');
                        }
                        await this.generateLTFSignal(htfData.signals, htfData.currentPrice, htfData.pivots);
                    }
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                } catch (error) {
                    console.error('Scan cycle error:', error);
                }
            }

            start() {
                if (this.isRunning) return;
                
                this.symbol = document.getElementById('symbolInput').value.toUpperCase() || 'BTCUSDT';
                this.interval = parseInt(document.getElementById('intervalSelect').value) * 1000;
                
                this.isRunning = true;
                this.startTime = Date.now();
                
                // Update UI
                document.getElementById('toggleBot').innerHTML = '<i class="fas fa-stop mr-2"></i>Botu Durdur';
                document.getElementById('toggleBot').className = 'w-full px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-medium flex items-center justify-center space-x-2';
                
                // Start intervals
                this.intervalId = setInterval(() => this.runScanCycle(), this.interval);
                this.uptimeInterval = setInterval(() => this.updateUptime(), 1000);
                
                // Run initial scan
                this.runScanCycle();
                
                console.log(`Bot started for ${this.symbol} with ${this.interval/1000}s interval`);
            }

            stop() {
                if (!this.isRunning) return;
                
                this.isRunning = false;
                this.startTime = null;
                
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                
                if (this.uptimeInterval) {
                    clearInterval(this.uptimeInterval);
                    this.uptimeInterval = null;
                }
                
                // Update UI
                document.getElementById('toggleBot').innerHTML = '<i class="fas fa-play mr-2"></i>Botu Başlat';
                document.getElementById('toggleBot').className = 'w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-medium flex items-center justify-center space-x-2';
                document.getElementById('uptime').textContent = '00:00:00';
                
                this.updateConnectionStatus(false);
                
                console.log('Bot stopped');
            }

            initializeEventListeners() {
                // Toggle bot
                document.getElementById('toggleBot').addEventListener('click', () => {
                    if (this.isRunning) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });

                // Clear history
                document.getElementById('clearHistory').addEventListener('click', () => {
                    document.getElementById('signalHistory').innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                            <p class="text-sm">Henüz sinyal geçmişi yok</p>
                        </div>
                    `;
                });

                // Modal close buttons
                document.getElementById('closeSignalModal').addEventListener('click', () => {
                    document.getElementById('signalModal').classList.add('hidden');
                });
                
                document.getElementById('ackSignalModal').addEventListener('click', () => {
                    document.getElementById('signalModal').classList.add('hidden');
                });

                // Symbol input validation
                document.getElementById('symbolInput').addEventListener('input', (e) => {
                    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
                });

                // Chart controls
                document.getElementById('chartTimeframe').addEventListener('change', () => {
                    this.updateTradingViewChart();
                });

                document.getElementById('refreshChart').addEventListener('click', () => {
                    this.updateTradingViewChart();
                });

                // Initialize TradingView chart
                this.initializeTradingViewChart();
            }

            // TradingView Chart Functions
            convertSymbolToTradingView(binanceSymbol) {
                // Convert Binance symbols to TradingView format
                const symbolMappings = {
                    'BTCUSDT': 'BINANCE:BTCUSDT',
                    'ETHUSDT': 'BINANCE:ETHUSDT',
                    'BNBUSDT': 'BINANCE:BNBUSDT',
                    'ADAUSDT': 'BINANCE:ADAUSDT',
                    'DOTUSDT': 'BINANCE:DOTUSDT',
                    'LINKUSDT': 'BINANCE:LINKUSDT',
                    'LTCUSDT': 'BINANCE:LTCUSDT',
                    'BCHUSDT': 'BINANCE:BCHUSDT',
                    'XLMUSDT': 'BINANCE:XLMUSDT',
                    'UNIUSDT': 'BINANCE:UNIUSDT',
                    'DOGEUSDT': 'BINANCE:DOGEUSDT',
                    'AVAXUSDT': 'BINANCE:AVAXUSDT',
                    'SOLUSDT': 'BINANCE:SOLUSDT',
                    'MATICUSDT': 'BINANCE:MATICUSDT'
                };
                
                return symbolMappings[binanceSymbol] || `BINANCE:${binanceSymbol}`;
            }

            initializeTradingViewChart() {
                const isDark = document.documentElement.classList.contains('dark');
                const timeframe = document.getElementById('chartTimeframe').value;
                const tvSymbol = this.convertSymbolToTradingView(this.symbol);

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "autosize": true,
                    "symbol": tvSymbol,
                    "interval": timeframe,
                    "timezone": "Europe/Istanbul",
                    "theme": isDark ? "dark" : "light",
                    "style": "1",
                    "locale": "tr",
                    "toolbar_bg": isDark ? "#1E2329" : "#f1f3f6",
                    "enable_publishing": false,
                    "backgroundColor": isDark ? "#1E2329" : "#ffffff",
                    "gridColor": isDark ? "rgba(255, 255, 255, 0.06)" : "rgba(46, 46, 46, 0.06)",
                    "allow_symbol_change": true,
                    "watchlist": [
                        "BINANCE:BTCUSDT",
                        "BINANCE:ETHUSDT",
                        "BINANCE:BNBUSDT",
                        "BINANCE:ADAUSDT",
                        "BINANCE:DOGEUSDT"
                    ],
                    "details": false,
                    "hotlist": false,
                    "calendar": false,
                    "studies": [
                        "RSI@tv-basicstudies",
                        "MASimple@tv-basicstudies",
                        "VWMA@tv-basicstudies"
                    ],
                    "hide_legend": false,
                    "hide_side_toolbar": false,
                    "hide_top_toolbar": false,
                    "save_image": false,
                    "container_id": "tradingview_chart"
                });

                // Clear existing chart
                const chartContainer = document.getElementById('tradingview_chart');
                chartContainer.innerHTML = `
                    <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                    <div class="tradingview-widget-copyright">
                        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                            <span class="text-xs text-gray-500">Powered by TradingView</span>
                        </a>
                    </div>
                `;

                // Add new script
                chartContainer.querySelector('.tradingview-widget-container__widget').appendChild(script);
            }

            updateTradingViewChart() {
                this.initializeTradingViewChart();
            }
        }

        // Initialize the bot when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const bot = new BinanceSignalBot();
            window.signalBot = bot; // Make available globally for debugging
        });
    </script>
</body>
</html>
