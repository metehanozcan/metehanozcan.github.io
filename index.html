<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kripto Trading Analiz - Strategy Back Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Roboto', sans-serif;
        }
        
        :root {
            --primary-color: #5D5CDE;
            --bg-light: #FFFFFF;
            --bg-dark: #181818;
            --text-light: #000000;
            --text-dark: #FFFFFF;
            --green: #22C55E;
            --red: #EF4444;
            --yellow: #FCD34D;
        }
        
        .dark {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        
        .dark body {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        
        .indicator-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin: 8px;
            transition: transform 0.2s ease;
        }
        
        .indicator-card:hover {
            transform: translateY(-2px);
        }
        
        .signal-bull {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
        }
        
        .signal-bear {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }
        
        .signal-neutral {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
        }
        
        .alarm-active {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .timeframe-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px;
        }
        
        .timeframe-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .price-display {
            font-size: 2rem;
            font-weight: 700;
            margin: 16px 0;
        }
        
        .price-up { color: var(--green); }
        .price-down { color: var(--red); }
        
        .strategy-panel {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(93, 92, 222, 0.05));
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                Kripto Trading Analiz Sistemi
            </h1>
            <p class="text-lg opacity-80">Strategy Back Test - RSI HEAT MAP, Multi Time Frame Analiz</p>
        </header>

        <!-- Ana Kontrol Paneli -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <div class="lg:col-span-3">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <div class="flex flex-wrap">
                        <select id="symbolSelect" class="bg-gray-800 text-white p-2 rounded-lg mr-4 text-base">
                            <option value="DRIFTUSDT">DRIFTUSDT</option>
                            <option value="TRUMPUSDT">TRUMPUSDT</option>
                            <option value="HYPEUSDT">HYPEUSDT</option>
                            <option value="BTCUSDT">BTCUSDT</option>
                            <option value="ETHUSDT">ETHUSDT</option>
                        </select>
                        
                        <div class="flex flex-wrap">
                            <button class="timeframe-btn active" data-tf="1m">1M</button>
                            <button class="timeframe-btn" data-tf="3m">3M</button>
                            <button class="timeframe-btn" data-tf="5m">5M</button>
                            <button class="timeframe-btn" data-tf="15m">15M</button>
                            <button class="timeframe-btn" data-tf="1h">1H</button>
                            <button class="timeframe-btn" data-tf="4h">4H</button>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <button id="alarmToggle" class="bg-yellow-500 text-black px-4 py-2 rounded-lg mr-4 font-semibold">
                            <i class="fas fa-bell mr-2"></i>Alarm: KAPALI
                        </button>
                        <div id="connectionStatus" class="text-green-500 font-semibold">
                            <i class="fas fa-circle mr-2"></i>CANLI
                        </div>
                    </div>
                </div>

                <!-- Fiyat Gösterimi -->
                <div class="bg-gray-900 rounded-lg p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold" id="currentSymbol">DRIFTUSDT</div>
                            <div class="price-display" id="currentPrice">$0.0000</div>
                            <div class="text-sm opacity-75" id="priceChange">24h Değişim: 0.00%</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm opacity-75">Hacim (24h)</div>
                            <div class="text-lg font-semibold" id="volume24h">$0</div>
                        </div>
                    </div>
                </div>

                <!-- Ana Grafik -->
                <div class="chart-container">
                    <canvas id="mainChart" width="800" height="400"></canvas>
                </div>
            </div>

            <!-- Göstergeler Paneli -->
            <div class="space-y-4">
                <div class="strategy-panel">
                    <h3 class="text-lg font-bold mb-4 text-center">BTC Trend Analizi</h3>
                    <div id="btcAnalysis" class="text-center">
                        <div class="text-3xl mb-2" id="btcPrice">$0</div>
                        <div class="text-sm" id="btcTrend">Trend Analiz Ediliyor...</div>
                    </div>
                </div>

                <div class="strategy-panel">
                    <h3 class="text-lg font-bold mb-4">A01 Stratejisi</h3>
                    <div class="space-y-3">
                        <div class="indicator-card" id="rsiA01">
                            <div class="text-sm font-semibold">RSI 21-34 SMA</div>
                            <div class="text-2xl font-bold">--</div>
                            <div class="text-xs">5M Timeframe</div>
                        </div>
                        <div class="indicator-card" id="emaA01">
                            <div class="text-sm font-semibold">EMA Cross 5-14</div>
                            <div class="text-lg font-bold">--</div>
                        </div>
                    </div>
                </div>

                <div class="strategy-panel">
                    <h3 class="text-lg font-bold mb-4">A02 Stratejisi</h3>
                    <div class="space-y-3">
                        <div class="indicator-card" id="aoIndicator">
                            <div class="text-sm font-semibold">AO (Awesome)</div>
                            <div class="text-2xl font-bold">--</div>
                            <div class="text-xs">Momentum</div>
                        </div>
                        <div class="indicator-card" id="eomIndicator">
                            <div class="text-sm font-semibold">EOM</div>
                            <div class="text-2xl font-bold">--</div>
                            <div class="text-xs">15M Kontrol</div>
                        </div>
                    </div>
                </div>

                <div class="strategy-panel">
                    <h3 class="text-lg font-bold mb-4">SMI & RSI Heat Map</h3>
                    <div class="space-y-3">
                        <div class="indicator-card" id="smiioIndicator">
                            <div class="text-sm font-semibold">SMI</div>
                            <div class="text-2xl font-bold">--</div>
                            <div class="text-xs">3M/5M Sinyal</div>
                        </div>
                        <div class="indicator-card" id="rsiHeatMap">
                            <div class="text-sm font-semibold">RSI Heat Map</div>
                            <div class="text-lg font-bold">Avarage: --</div>
                            <div class="text-xs">15M/1H Tarama</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi Time Frame Analizi -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="strategy-panel">
                <h3 class="text-lg font-bold mb-4 text-center">HTF Analiz (1H/4H)</h3>
                <div id="htfAnalysis">
                    <div class="text-sm mb-2">Arz-Talep Bölgeleri:</div>
                    <div class="space-y-2" id="supplyDemandZones">
                        <div class="text-xs bg-red-500 bg-opacity-20 p-2 rounded">Arz: $0.00 - $0.00</div>
                        <div class="text-xs bg-green-500 bg-opacity-20 p-2 rounded">Talep: $0.00 - $0.00</div>
                    </div>
                </div>
            </div>

            <div class="strategy-panel">
                <h3 class="text-lg font-bold mb-4 text-center">MTF Analiz (15M)</h3>
                <div id="mtfAnalysis">
                    <div class="text-sm mb-2">Fibonacci Seviyeleri:</div>
                    <div class="space-y-1 text-xs" id="fibLevels">
                        <div>0.618: $0.00</div>
                        <div>0.705: $0.00</div>
                        <div>0.786: $0.00</div>
                    </div>
                </div>
            </div>

            <div class="strategy-panel">
                <h3 class="text-lg font-bold mb-4 text-center">LTF Analiz (3M/5M)</h3>
                <div id="ltfAnalysis">
                    <div class="text-sm mb-2">Osilatör Sinyalleri:</div>
                    <div class="space-y-2" id="oscillatorSignals">
                        <div class="text-xs">Teyit Bekliyor...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alarm Sistemi -->
        <div id="alarmPanel" class="bg-red-900 bg-opacity-50 rounded-lg p-4 mb-6 hidden">
            <h3 class="text-lg font-bold mb-2 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                Sinyal Alarmı
            </h3>
            <div id="alarmMessage" class="text-sm"></div>
        </div>

        <!-- İşlem Geçmişi -->
        <div class="strategy-panel">
            <h3 class="text-lg font-bold mb-4">Sinyal Geçmişi</h3>
            <div id="signalHistory" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="text-sm opacity-75">Sinyal geçmişi burada görünecek...</div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let currentSymbol = 'DRIFTUSDT';
        let currentTimeframe = '1m';
        let alarmEnabled = false;
        let priceData = [];
        let mainChart;
        let wsConnection;
        let lastSignalTime = 0;

        // Fibonacci calculation functions
        function calculateFibonacciLevels(high, low, isRetracement = true) {
            const diff = high - low;
            const levels = isRetracement ? 
                [0, 0.236, 0.382, 0.5, 0.618, 0.705, 0.786, 1] :
                [0, 0.618, 1, 1.618, 2.618, 4.236];
            
            return levels.map(level => ({
                level: level,
                price: isRetracement ? high - (diff * level) : low + (diff * level),
                label: `${(level * 100).toFixed(1)}%`
            }));
        }

        function findSwingHighLow(highs, lows, period = 20) {
            if (highs.length < period) return null;
            
            const recentHighs = highs.slice(-period);
            const recentLows = lows.slice(-period);
            
            const swingHigh = Math.max(...recentHighs);
            const swingLow = Math.min(...recentLows);
            
            return { high: swingHigh, low: swingLow };
        }

        function detectSupplyDemandZones(highs, lows, closes, volumes) {
            const zones = [];
            const lookback = 20;
            
            if (highs.length < lookback) return zones;
            
            for (let i = lookback; i < highs.length - 5; i++) {
                const currentHigh = highs[i];
                const currentLow = lows[i];
                const currentVolume = volumes[i];
                
                // Supply zone detection (yüksek hacimli tepeler)
                const isLocalHigh = highs.slice(i-5, i+5).every(h => h <= currentHigh);
                const highVolume = currentVolume > volumes.slice(i-10, i+10).reduce((a,b) => a+b) / 20 * 1.5;
                
                if (isLocalHigh && highVolume) {
                    zones.push({
                        type: 'supply',
                        top: currentHigh * 1.002,
                        bottom: currentHigh * 0.998,
                        strength: currentVolume,
                        index: i
                    });
                }
                
                // Demand zone detection (yüksek hacimli dipler)
                const isLocalLow = lows.slice(i-5, i+5).every(l => l >= currentLow);
                
                if (isLocalLow && highVolume) {
                    zones.push({
                        type: 'demand',
                        top: currentLow * 1.002,
                        bottom: currentLow * 0.998,
                        strength: currentVolume,
                        index: i
                    });
                }
            }
            
            return zones.slice(-10); // Son 10 bölgeyi tut
        }

        function calculatePivotLevels(high, low, close) {
            const pivot = (high + low + close) / 3;
            
            return {
                PP: pivot,
                R1: (2 * pivot) - low,
                R2: pivot + (high - low),
                R3: high + 2 * (pivot - low),
                S1: (2 * pivot) - high,
                S2: pivot - (high - low),
                S3: low - 2 * (high - pivot)
            };
        }

        function detectCandlestickPatterns(opens, highs, lows, closes) {
            if (closes.length < 3) return [];
            
            const patterns = [];
            const lastIndex = closes.length - 1;
            
            // Pinbar detection
            const bodySize = Math.abs(closes[lastIndex] - opens[lastIndex]);
            const upperWick = highs[lastIndex] - Math.max(opens[lastIndex], closes[lastIndex]);
            const lowerWick = Math.min(opens[lastIndex], closes[lastIndex]) - lows[lastIndex];
            const totalRange = highs[lastIndex] - lows[lastIndex];
            
            if (upperWick > bodySize * 2 && upperWick > totalRange * 0.6) {
                patterns.push({ type: 'bearish_pinbar', strength: upperWick / bodySize });
            }
            
            if (lowerWick > bodySize * 2 && lowerWick > totalRange * 0.6) {
                patterns.push({ type: 'bullish_pinbar', strength: lowerWick / bodySize });
            }
            
            // Doji detection
            if (bodySize < totalRange * 0.1) {
                patterns.push({ type: 'doji', strength: totalRange / bodySize });
            }
            
            // Engulfing pattern
            if (lastIndex > 0) {
                const prevBodySize = Math.abs(closes[lastIndex-1] - opens[lastIndex-1]);
                const currentIsBullish = closes[lastIndex] > opens[lastIndex];
                const prevIsBearish = closes[lastIndex-1] < opens[lastIndex-1];
                
                if (currentIsBullish && prevIsBearish && 
                    closes[lastIndex] > opens[lastIndex-1] && 
                    opens[lastIndex] < closes[lastIndex-1]) {
                    patterns.push({ type: 'bullish_engulfing', strength: bodySize / prevBodySize });
                }
            }
            
            return patterns;
        }

        function detectImbalances(highs, lows, threshold = 0.002) {
            const imbalances = [];
            
            for (let i = 1; i < highs.length - 1; i++) {
                const gap = lows[i+1] - highs[i-1];
                const avgPrice = (highs[i] + lows[i]) / 2;
                
                if (Math.abs(gap) / avgPrice > threshold) {
                    imbalances.push({
                        start: highs[i-1],
                        end: lows[i+1],
                        size: Math.abs(gap),
                        index: i,
                        filled: false
                    });
                }
            }
            
            return imbalances.slice(-5); // Son 5 imbalance
        }

        // Technical indicators calculation functions
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = 1; i <= period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateSMA(prices, period) {
            if (prices.length < period) return null;
            const sum = prices.slice(-period).reduce((a, b) => a + b, 0);
            return sum / period;
        }

        function calculateEMA(prices, period) {
            if (prices.length < period) return null;
            
            const multiplier = 2 / (period + 1);
            let ema = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < prices.length; i++) {
                ema = (prices[i] * multiplier) + (ema * (1 - multiplier));
            }
            
            return ema;
        }

        function calculateAO(highs, lows, fastPeriod = 5, slowPeriod = 34) {
            if (highs.length < slowPeriod || lows.length < slowPeriod) return null;
            
            const medianPrices = highs.map((high, i) => (high + lows[i]) / 2);
            const fastSMA = calculateSMA(medianPrices, fastPeriod);
            const slowSMA = calculateSMA(medianPrices, slowPeriod);
            
            return fastSMA - slowSMA;
        }

        function calculateEOM(highs, lows, closes, volumes, period = 14) {
            if (highs.length < 2) return null;
            
            const distance = (highs[highs.length - 1] + lows[lows.length - 1]) / 2 - 
                           (highs[highs.length - 2] + lows[lows.length - 2]) / 2;
            
            const boxHeight = (volumes[volumes.length - 1] / 1000000) / 
                            (highs[highs.length - 1] - lows[lows.length - 1]);
            
            const emv = distance / boxHeight;
            return emv;
        }

        function calculateSMI(highs, lows, closes, kPeriod = 13, dPeriod = 25, smoothing = 2) {
            // SMI (Stochastic Momentum Index) calculation
            if (closes.length < Math.max(kPeriod, dPeriod)) return null;
            
            const smiValues = [];
            
            for (let i = kPeriod - 1; i < closes.length; i++) {
                const periodHighs = highs.slice(i - kPeriod + 1, i + 1);
                const periodLows = lows.slice(i - kPeriod + 1, i + 1);
                const periodCloses = closes.slice(i - kPeriod + 1, i + 1);
                
                const highestHigh = Math.max(...periodHighs);
                const lowestLow = Math.min(...periodLows);
                const currentClose = periodCloses[periodCloses.length - 1];
                const midpoint = (highestHigh + lowestLow) / 2;
                
                const smi = ((currentClose - midpoint) / ((highestHigh - lowestLow) / 2)) * 100;
                smiValues.push(smi);
            }
            
            // Apply EMA smoothing
            if (smiValues.length === 0) return null;
            
            let smoothedSMI = smiValues[0];
            const multiplier = 2 / (smoothing + 1);
            
            for (let i = 1; i < smiValues.length; i++) {
                smoothedSMI = (smiValues[i] * multiplier) + (smoothedSMI * (1 - multiplier));
            }
            
            return smoothedSMI;
        }

        // Chart initialization
        function initializeChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Fiyat',
                        data: [],
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'RSI',
                        data: [],
                        borderColor: '#22C55E',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        hidden: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            min: 0,
                            max: 100,
                            ticks: { color: 'white' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Binance API functions
        async function fetchKlineData(symbol, interval, limit = 100) {
            try {
                const response = await fetch(
                    `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`
                );
                const data = await response.json();
                
                return data.map(kline => ({
                    time: new Date(kline[0]),
                    open: parseFloat(kline[1]),
                    high: parseFloat(kline[2]),
                    low: parseFloat(kline[3]),
                    close: parseFloat(kline[4]),
                    volume: parseFloat(kline[5])
                }));
            } catch (error) {
                console.error('Kline data fetch error:', error);
                return [];
            }
        }

        async function fetch24hrTicker(symbol) {
            try {
                const response = await fetch(
                    `https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`
                );
                return await response.json();
            } catch (error) {
                console.error('24hr ticker fetch error:', error);
                return null;
            }
        }

        // WebSocket connection for real-time data
        function connectWebSocket() {
            if (wsConnection) {
                wsConnection.close();
            }

            const wsUrl = `wss://stream.binance.com:9443/ws/${currentSymbol.toLowerCase()}@ticker`;
            wsConnection = new WebSocket(wsUrl);

            wsConnection.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-circle mr-2 text-green-500"></i>CANLI';
            };

            wsConnection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updatePriceDisplay(data);
            };

            wsConnection.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connectionStatus').innerHTML = 
                    '<i class="fas fa-circle mr-2 text-red-500"></i>BAĞLANTI KESİK';
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            wsConnection.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Update price display
        function updatePriceDisplay(tickerData) {
            const price = parseFloat(tickerData.c);
            const change = parseFloat(tickerData.P);
            
            document.getElementById('currentPrice').textContent = `$${price.toFixed(6)}`;
            document.getElementById('priceChange').textContent = `24h Değişim: ${change.toFixed(2)}%`;
            
            const priceElement = document.getElementById('currentPrice');
            priceElement.className = change >= 0 ? 'price-display price-up' : 'price-display price-down';
            
            document.getElementById('volume24h').textContent = 
                `$${parseFloat(tickerData.v).toLocaleString()}`;
        }

        // Calculate and update indicators
        async function updateIndicators() {
            const klineData = await fetchKlineData(currentSymbol, currentTimeframe, 200);
            if (klineData.length === 0) return;

            const closes = klineData.map(k => k.close);
            const highs = klineData.map(k => k.high);
            const lows = klineData.map(k => k.low);
            const volumes = klineData.map(k => k.volume);

            // Update chart
            updateChart(klineData);

            // Calculate indicators
            const rsi14 = calculateRSI(closes, 14);
            const rsi21 = calculateRSI(closes, 21);
            const rsi34 = calculateRSI(closes, 34);
            const ema5 = calculateEMA(closes, 5);
            const ema14 = calculateEMA(closes, 14);
            const ao = calculateAO(highs, lows);
            const eom = calculateEOM(highs, lows, closes, volumes);
            const smi = calculateSMI(highs, lows, closes);

            // Update A01 Strategy (RSI 21-34 SMA)
            updateA01Strategy(rsi21, rsi34, ema5, ema14);
            
            // Update A02 Strategy (AO, EOM)
            updateA02Strategy(ao, eom);
            
            // Update SMI
            updateSMI(smi);
            
            // Update RSI Heat Map
            updateRSIHeatMap(rsi14, rsi21, rsi34);

            // Calculate advanced analysis
            const swingLevels = findSwingHighLow(highs, lows);
            const supplyDemandZones = detectSupplyDemandZones(highs, lows, closes, volumes);
            const candlestickPatterns = detectCandlestickPatterns(klineData.map(k => k.open), highs, lows, closes);
            const imbalances = detectImbalances(highs, lows);
            
            // Update HTF-MTF-LTF Analysis
            await updateHTFMTFLTFAnalysis(swingLevels, supplyDemandZones, candlestickPatterns, imbalances);

            // Check for signals
            checkSignals(rsi21, rsi34, ao, eom, smi, ema5, ema14, candlestickPatterns, supplyDemandZones);
        }

        function updateChart(klineData) {
            const labels = klineData.map(k => k.time.toLocaleTimeString());
            const prices = klineData.map(k => k.close);
            const rsiData = klineData.map(k => calculateRSI(klineData.slice(0, klineData.indexOf(k) + 1).map(x => x.close), 14));

            mainChart.data.labels = labels;
            mainChart.data.datasets[0].data = prices;
            mainChart.data.datasets[1].data = rsiData;
            mainChart.update('none');
        }

        function updateA01Strategy(rsi21, rsi34, ema5, ema14) {
            const rsiElement = document.getElementById('rsiA01');
            const emaElement = document.getElementById('emaA01');

            if (rsi21 && rsi34) {
                const rsiSignal = (rsi21 < 34 && rsi34 < 34) ? 'AŞIRI SATIŞ' : 
                                 (rsi21 > 66 && rsi34 > 66) ? 'AŞIRI ALIŞ' : 'NÖTR';
                
                rsiElement.innerHTML = `
                    <div class="text-sm font-semibold">RSI 21-34 SMA</div>
                    <div class="text-2xl font-bold">${rsi21.toFixed(1)}</div>
                    <div class="text-xs">${rsiSignal}</div>
                `;
                
                rsiElement.className = `indicator-card ${
                    rsiSignal === 'AŞIRI SATIŞ' ? 'signal-bull' :
                    rsiSignal === 'AŞIRI ALIŞ' ? 'signal-bear' : 'signal-neutral'
                }`;
            }

            if (ema5 && ema14) {
                const emaCross = ema5 > ema14 ? 'YUKARI KESIŞ' : 'AŞAĞI KESIŞ';
                
                emaElement.innerHTML = `
                    <div class="text-sm font-semibold">EMA Cross 5-14</div>
                    <div class="text-lg font-bold">${emaCross}</div>
                `;
                
                emaElement.className = `indicator-card ${
                    emaCross === 'YUKARI KESIŞ' ? 'signal-bull' : 'signal-bear'
                }`;
            }
        }

        function updateA02Strategy(ao, eom) {
            const aoElement = document.getElementById('aoIndicator');
            const eomElement = document.getElementById('eomIndicator');

            if (ao !== null) {
                const aoSignal = ao > 0 ? 'POZİTİF' : 'NEGATİF';
                
                aoElement.innerHTML = `
                    <div class="text-sm font-semibold">AO (Awesome)</div>
                    <div class="text-2xl font-bold">${ao.toFixed(4)}</div>
                    <div class="text-xs">${aoSignal}</div>
                `;
                
                aoElement.className = `indicator-card ${
                    ao > 0 ? 'signal-bull' : 'signal-bear'
                }`;
            }

            if (eom !== null) {
                const eomSignal = eom > 0 ? 'POZİTİF' : 'NEGATİF';
                
                eomElement.innerHTML = `
                    <div class="text-sm font-semibold">EOM</div>
                    <div class="text-2xl font-bold">${eom.toFixed(4)}</div>
                    <div class="text-xs">${eomSignal}</div>
                `;
                
                eomElement.className = `indicator-card ${
                    eom > 0 ? 'signal-bull' : 'signal-bear'
                }`;
            }
        }

        function updateSMI(smi) {
            const smiElement = document.getElementById('smiioIndicator');

            if (smi !== null) {
                const smiSignal = smi < -40 ? 'AŞIRI SATIŞ' :
                                 smi > 40 ? 'AŞIRI ALIŞ' : 'NÖTR';
                
                smiElement.innerHTML = `
                    <div class="text-sm font-semibold">SMI</div>
                    <div class="text-2xl font-bold">${smi.toFixed(1)}</div>
                    <div class="text-xs">${smiSignal}</div>
                `;
                
                smiElement.className = `indicator-card ${
                    smiSignal === 'AŞIRI SATIŞ' ? 'signal-bull' :
                    smiSignal === 'AŞIRI ALIŞ' ? 'signal-bear' : 'signal-neutral'
                }`;
            }
        }

        function updateRSIHeatMap(rsi14, rsi21, rsi34) {
            const heatMapElement = document.getElementById('rsiHeatMap');

            if (rsi14 && rsi21 && rsi34) {
                const average = (rsi14 + rsi21 + rsi34) / 3;
                const heatMapSignal = average < 30 ? 'AŞIRI SATIŞ' :
                                     average > 70 ? 'AŞIRI ALIŞ' : 'NÖTR';
                
                heatMapElement.innerHTML = `
                    <div class="text-sm font-semibold">RSI Heat Map</div>
                    <div class="text-lg font-bold">Avarage: ${average.toFixed(1)}</div>
                    <div class="text-xs">${heatMapSignal}</div>
                `;
                
                heatMapElement.className = `indicator-card ${
                    heatMapSignal === 'AŞIRI SATIŞ' ? 'signal-bull' :
                    heatMapSignal === 'AŞIRI ALIŞ' ? 'signal-bear' : 'signal-neutral'
                }`;
            }
        }

        // HTF-MTF-LTF Analysis update function
        async function updateHTFMTFLTFAnalysis(swingLevels, supplyDemandZones, candlestickPatterns, imbalances) {
            // HTF Analysis - Supply/Demand Zones
            const supplyDemandElement = document.getElementById('supplyDemandZones');
            if (supplyDemandZones.length > 0) {
                const supplyZones = supplyDemandZones.filter(z => z.type === 'supply').slice(-2);
                const demandZones = supplyDemandZones.filter(z => z.type === 'demand').slice(-2);
                
                let html = '';
                supplyZones.forEach(zone => {
                    html += `<div class="text-xs bg-red-500 bg-opacity-20 p-2 rounded mb-1">
                        🔴 Arz: $${zone.bottom.toFixed(4)} - $${zone.top.toFixed(4)}
                        <div class="text-xs opacity-75">Güç: ${zone.strength.toFixed(0)}</div>
                    </div>`;
                });
                demandZones.forEach(zone => {
                    html += `<div class="text-xs bg-green-500 bg-opacity-20 p-2 rounded mb-1">
                        🟢 Talep: $${zone.bottom.toFixed(4)} - $${zone.top.toFixed(4)}
                        <div class="text-xs opacity-75">Güç: ${zone.strength.toFixed(0)}</div>
                    </div>`;
                });
                supplyDemandElement.innerHTML = html;
            }

            // MTF Analysis - Fibonacci Levels
            const fibElement = document.getElementById('fibLevels');
            if (swingLevels) {
                const fibLevels = calculateFibonacciLevels(swingLevels.high, swingLevels.low, true);
                const importantLevels = fibLevels.filter(l => [0.382, 0.5, 0.618, 0.705, 0.786].includes(l.level));
                
                const html = importantLevels.map(level => 
                    `<div class="flex justify-between">
                        <span>${level.label}:</span>
                        <span class="font-semibold">$${level.price.toFixed(4)}</span>
                    </div>`
                ).join('');
                fibElement.innerHTML = html;

                // Fibonacci Extension hesaplama
                const fibExtension = calculateFibonacciLevels(swingLevels.high, swingLevels.low, false);
                const extLevels = fibExtension.filter(l => [1.618, 2.618].includes(l.level));
                
                if (extLevels.length > 0) {
                    fibElement.innerHTML += '<div class="mt-2 pt-2 border-t border-gray-600 text-xs opacity-75">Extension:</div>';
                    extLevels.forEach(level => {
                        fibElement.innerHTML += `<div class="flex justify-between text-xs">
                            <span>${level.label}:</span>
                            <span>$${level.price.toFixed(4)}</span>
                        </div>`;
                    });
                }
            }

            // LTF Analysis - Oscillator Signals & Patterns
            const ltfElement = document.getElementById('oscillatorSignals');
            let ltfHtml = '';
            
            if (candlestickPatterns.length > 0) {
                ltfHtml += '<div class="text-xs font-semibold mb-1">Mum Formasyonları:</div>';
                candlestickPatterns.forEach(pattern => {
                    const patternName = {
                        'bullish_pinbar': '🟢 Yükseliş Pinbar',
                        'bearish_pinbar': '🔴 Düşüş Pinbar',
                        'doji': '⚪ Doji',
                        'bullish_engulfing': '🟢 Yükseliş Sarmalama'
                    }[pattern.type] || pattern.type;
                    
                    ltfHtml += `<div class="text-xs bg-blue-500 bg-opacity-20 p-1 rounded mb-1">
                        ${patternName} (${pattern.strength.toFixed(1)})
                    </div>`;
                });
            }

            if (imbalances.length > 0) {
                ltfHtml += '<div class="text-xs font-semibold mb-1 mt-2">Imbalance Bölgeleri:</div>';
                imbalances.slice(-3).forEach(imb => {
                    ltfHtml += `<div class="text-xs bg-yellow-500 bg-opacity-20 p-1 rounded mb-1">
                        📊 $${imb.start.toFixed(4)} - $${imb.end.toFixed(4)}
                    </div>`;
                });
            }

            if (ltfHtml === '') {
                ltfHtml = '<div class="text-xs opacity-75">Sinyal bekleniyor...</div>';
            }
            
            ltfElement.innerHTML = ltfHtml;
        }

        // Signal detection and alarm system
        function checkSignals(rsi21, rsi34, ao, eom, smi, ema5, ema14, candlestickPatterns = [], supplyDemandZones = []) {
            const now = Date.now();
            if (now - lastSignalTime < 30000) return; // 30 saniye throttle

            let signals = [];

            // A01 Strategy signals
            if (rsi21 && rsi34 && rsi21 < 34 && rsi34 < 34) {
                signals.push('A01: RSI Aşırı Satış Sinyali');
            }

            if (ema5 && ema14 && ema5 > ema14) {
                signals.push('A01: EMA Yukarı Kesişim');
            }

            // A02 Strategy signals
            if (ao !== null && ao > 0) {
                signals.push('A02: AO Pozitif Sinyal');
            }

            if (eom !== null && eom > 0) {
                signals.push('A02: EOM Pozitif Sinyal');
            }

            // SMI signals
            if (smi !== null && smi < -40) {
                signals.push('SMI: Aşırı Satış Bölgesi');
            }

            // Candlestick Pattern signals
            candlestickPatterns.forEach(pattern => {
                if (pattern.strength > 2) {
                    const patternSignal = {
                        'bullish_pinbar': 'Pinbar: Yükseliş Sinyali',
                        'bearish_pinbar': 'Pinbar: Düşüş Sinyali',
                        'doji': 'Doji: Kararsızlık Sinyali',
                        'bullish_engulfing': 'Engulfing: Yükseliş Sinyali'
                    }[pattern.type];
                    
                    if (patternSignal) {
                        signals.push(patternSignal);
                    }
                }
            });

            // Supply/Demand Zone signals
            const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace('$', ''));
            if (currentPrice > 0) {
                supplyDemandZones.forEach(zone => {
                    if (zone.type === 'supply' && currentPrice >= zone.bottom && currentPrice <= zone.top) {
                        signals.push(`Arz Bölgesi: Fiyat arz bölgesinde! ($${zone.bottom.toFixed(4)} - $${zone.top.toFixed(4)})`);
                    }
                    if (zone.type === 'demand' && currentPrice >= zone.bottom && currentPrice <= zone.top) {
                        signals.push(`Talep Bölgesi: Fiyat talep bölgesinde! ($${zone.bottom.toFixed(4)} - $${zone.top.toFixed(4)})`);
                    }
                });
            }

            if (signals.length > 0 && alarmEnabled) {
                showAlarm(signals);
                addToSignalHistory(signals);
                lastSignalTime = now;
            }
        }

        function showAlarm(signals) {
            const alarmPanel = document.getElementById('alarmPanel');
            const alarmMessage = document.getElementById('alarmMessage');
            
            alarmMessage.innerHTML = signals.map(signal => 
                `<div class="alarm-active">🚨 ${signal}</div>`
            ).join('');
            
            alarmPanel.classList.remove('hidden');
            alarmPanel.classList.add('alarm-active');
            
            // Play sound (if browser allows)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEATIEAAASCCQACAQ...');
                audio.play().catch(() => {});
            } catch (e) {}
            
            // Hide alarm after 10 seconds
            setTimeout(() => {
                alarmPanel.classList.add('hidden');
                alarmPanel.classList.remove('alarm-active');
            }, 10000);
        }

        function addToSignalHistory(signals) {
            const historyElement = document.getElementById('signalHistory');
            const timestamp = new Date().toLocaleTimeString();
            
            signals.forEach(signal => {
                const signalDiv = document.createElement('div');
                signalDiv.className = 'text-sm p-2 bg-blue-500 bg-opacity-20 rounded mb-2';
                signalDiv.innerHTML = `<span class="font-bold">${timestamp}</span> - ${signal}`;
                historyElement.insertBefore(signalDiv, historyElement.firstChild);
            });
            
            // Keep only last 20 signals
            while (historyElement.children.length > 20) {
                historyElement.removeChild(historyElement.lastChild);
            }
        }

        // BTC trend analysis
        async function updateBTCAnalysis() {
            if (currentSymbol !== 'BTCUSDT') {
                const btcTicker = await fetch24hrTicker('BTCUSDT');
                if (btcTicker) {
                    const btcPrice = parseFloat(btcTicker.lastPrice);
                    const btcChange = parseFloat(btcTicker.priceChangePercent);
                    
                    document.getElementById('btcPrice').textContent = `$${btcPrice.toLocaleString()}`;
                    document.getElementById('btcTrend').textContent = 
                        `${btcChange >= 0 ? '📈' : '📉'} %${btcChange.toFixed(2)}`;
                    
                    const btcAnalysis = document.getElementById('btcAnalysis');
                    btcAnalysis.className = btcChange >= 0 ? 'text-center text-green-400' : 'text-center text-red-400';
                }
            }
        }

        // Event listeners
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            document.getElementById('currentSymbol').textContent = currentSymbol;
            connectWebSocket();
            updateIndicators();
        });

        document.querySelectorAll('.timeframe-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentTimeframe = e.target.dataset.tf;
                updateIndicators();
            });
        });

        document.getElementById('alarmToggle').addEventListener('click', (e) => {
            alarmEnabled = !alarmEnabled;
            e.target.innerHTML = alarmEnabled ? 
                '<i class="fas fa-bell mr-2"></i>Alarm: AÇIK' :
                '<i class="fas fa-bell-slash mr-2"></i>Alarm: KAPALI';
            e.target.className = alarmEnabled ? 
                'bg-green-500 text-white px-4 py-2 rounded-lg mr-4 font-semibold' :
                'bg-yellow-500 text-black px-4 py-2 rounded-lg mr-4 font-semibold';
        });

        // Initialize application
        async function initialize() {
            initializeChart();
            connectWebSocket();
            await updateIndicators();
            await updateBTCAnalysis();
            
            // Update indicators every 10 seconds
            setInterval(updateIndicators, 10000);
            
            // Update BTC analysis every 30 seconds
            setInterval(updateBTCAnalysis, 30000);
        }

        // Start the application
        initialize();
    </script>
</body>
</html>
